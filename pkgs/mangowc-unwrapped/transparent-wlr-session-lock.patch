From ee4bcb1a934b9033944a53ab4a2f5563c550c176 Mon Sep 17 00:00:00 2001
From: Rexiel Scarlet <37258415+Rexcrazy804@users.noreply.github.com>
Date: Sun, 23 Nov 2025 20:20:47 +0400
Subject: [PATCH] feat: support transparent wlr session lock

---
 src/config/parse_config.h | 5 +++++
 src/config/preset.h       | 1 +
 src/mango.c               | 8 ++++++--
 3 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/src/config/parse_config.h b/src/config/parse_config.h
index 72140d1..9cc5490 100644
--- a/src/config/parse_config.h
+++ b/src/config/parse_config.h
@@ -328,6 +328,7 @@ typedef struct {
 	int xwayland_persistence;
 	int syncobj_enable;
 	int adaptive_sync;
+	int transparent_wlr_lock;
 
 	struct xkb_rule_names xkb_rules;
 
@@ -1232,6 +1233,8 @@ void parse_option(Config *config, char *key, char *value) {
 		config->syncobj_enable = atoi(value);
 	} else if (strcmp(key, "adaptive_sync") == 0) {
 		config->adaptive_sync = atoi(value);
+	} else if (strcmp(key, "transparent_wlr_lock") == 0) {
+		config->transparent_wlr_lock = atoi(value);
 	} else if (strcmp(key, "no_border_when_single") == 0) {
 		config->no_border_when_single = atoi(value);
 	} else if (strcmp(key, "no_radius_when_single") == 0) {
@@ -2642,6 +2645,7 @@ void override_config(void) {
 	xwayland_persistence = CLAMP_INT(config.xwayland_persistence, 0, 1);
 	syncobj_enable = CLAMP_INT(config.syncobj_enable, 0, 1);
 	adaptive_sync = CLAMP_INT(config.adaptive_sync, 0, 1);
+	transparent_wlr_lock = CLAMP_INT(config.transparent_wlr_lock, 0, 1);
 	axis_bind_apply_timeout =
 		CLAMP_INT(config.axis_bind_apply_timeout, 0, 1000);
 	focus_on_activate = CLAMP_INT(config.focus_on_activate, 0, 1);
@@ -2816,6 +2820,7 @@ void set_value_default() {
 	config.xwayland_persistence = xwayland_persistence;
 	config.syncobj_enable = syncobj_enable;
 	config.adaptive_sync = adaptive_sync;
+	config.transparent_wlr_lock = transparent_wlr_lock;
 	config.no_border_when_single = no_border_when_single;
 	config.no_radius_when_single = no_radius_when_single;
 	config.snap_distance = snap_distance;
diff --git a/src/config/preset.h b/src/config/preset.h
index 39cf509..e69cb01 100644
--- a/src/config/preset.h
+++ b/src/config/preset.h
@@ -102,6 +102,7 @@ int warpcursor = 1;			  /* Warp cursor to focused client */
 int xwayland_persistence = 1; /* xwayland persistence */
 int syncobj_enable = 0;
 int adaptive_sync = 0;
+int transparent_wlr_lock = 0;
 double drag_refresh_interval = 30.0;
 
 /* keyboard */
diff --git a/src/mango.c b/src/mango.c
index 690775b..fc62f19 100644
--- a/src/mango.c
+++ b/src/mango.c
@@ -2953,7 +2953,9 @@ void destroylock(SessionLock *lock, int unlock) {
 	if ((locked = !unlock))
 		goto destroy;
 
-	wlr_scene_node_set_enabled(&locked_bg->node, false);
+	if (!config.transparent_wlr_lock) {
+		wlr_scene_node_set_enabled(&locked_bg->node, false);
+	}
 
 	focusclient(focustop(selmon), 0);
 	motionnotify(0, NULL, 0, 0, 0, 0);
@@ -3451,7 +3453,9 @@ void pending_kill_client(Client *c) {
 void locksession(struct wl_listener *listener, void *data) {
 	struct wlr_session_lock_v1 *session_lock = data;
 	SessionLock *lock;
-	wlr_scene_node_set_enabled(&locked_bg->node, true);
+  if (!config.transparent_wlr_lock) {
+		wlr_scene_node_set_enabled(&locked_bg->node, true);
+  }
 	if (cur_lock) {
 		wlr_session_lock_v1_destroy(session_lock);
 		return;
-- 
2.51.0

